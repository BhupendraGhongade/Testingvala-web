<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Persistence Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .pass { background: #d4edda; }
        .fail { background: #f8d7da; }
        button { padding: 8px 16px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .logs { background: #f8f9fa; padding: 10px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Post Persistence Test</h1>
    
    <div>
        <button onclick="createPost()">Create Test Post</button>
        <button onclick="validatePost()">Validate Post</button>
        <button onclick="hardReload()">Hard Reload</button>
        <button onclick="clearData()">Clear Data</button>
    </div>
    
    <div id="results"></div>
    <div id="logs" class="logs">Ready...\n</div>

    <script>
        let testPostId = null;
        
        function log(message) {
            const entry = `[${new Date().toISOString()}] ${message}`;
            console.log(entry);
            document.getElementById('logs').textContent += entry + '\n';
        }
        
        function addResult(test, passed, message) {
            const div = document.createElement('div');
            div.className = `test ${passed ? 'pass' : 'fail'}`;
            div.innerHTML = `<strong>${test}:</strong> ${passed ? 'PASS' : 'FAIL'} - ${message}`;
            document.getElementById('results').appendChild(div);
            log(`${test}: ${passed ? 'PASS' : 'FAIL'} - ${message}`);
        }
        
        function createPost() {
            const post = {
                id: `test_${Date.now()}`,
                title: 'Test Post',
                content: 'Persistence test post',
                created_at: new Date().toISOString(),
                isLocal: true
            };
            
            testPostId = post.id;
            
            try {
                const existing = JSON.parse(localStorage.getItem('testingvala_posts') || '[]');
                existing.unshift(post);
                localStorage.setItem('testingvala_posts', JSON.stringify(existing));
                
                addResult('Create Post', true, `Post created: ${post.id}`);
            } catch (error) {
                addResult('Create Post', false, `Error: ${error.message}`);
            }
        }
        
        function validatePost() {
            if (!testPostId) {
                addResult('Validate Post', false, 'No test post ID');
                return;
            }
            
            try {
                const stored = JSON.parse(localStorage.getItem('testingvala_posts') || '[]');
                const found = stored.find(p => p.id === testPostId);
                
                addResult('Validate Post', !!found, found ? `Found: ${found.title}` : `Not found: ${testPostId}`);
            } catch (error) {
                addResult('Validate Post', false, `Error: ${error.message}`);
            }
        }
        
        function hardReload() {
            log('Hard reload initiated...');
            window.location.reload(true);
        }
        
        function clearData() {
            localStorage.removeItem('testingvala_posts');
            testPostId = null;
            document.getElementById('results').innerHTML = '';
            document.getElementById('logs').textContent = 'Cleared.\n';
        }
        
        // Check on load
        window.addEventListener('load', () => {
            const stored = JSON.parse(localStorage.getItem('testingvala_posts') || '[]');
            const testPosts = stored.filter(p => p.id && p.id.startsWith('test_'));
            
            if (testPosts.length > 0) {
                testPostId = testPosts[0].id;
                addResult('Page Load', true, `Found ${testPosts.length} test post(s) after reload`);
            }
            
            log(`Loaded - ${stored.length} total posts, ${testPosts.length} test posts`);
        });
    </script>
</body>
</html>