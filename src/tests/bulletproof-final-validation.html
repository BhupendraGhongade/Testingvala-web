<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulletproof Final Validation</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test { margin: 15px 0; padding: 15px; border-radius: 8px; }
        .pass { background: #d4edda; border-left: 4px solid #28a745; }
        .fail { background: #f8d7da; border-left: 4px solid #dc3545; }
        .pending { background: #fff3cd; border-left: 4px solid #ffc107; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .logs { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin: 15px 0; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; font-size: 12px; }
        .checklist { background: #e7f3ff; padding: 15px; margin: 15px 0; border-radius: 5px; }
        .checklist h3 { margin-top: 0; }
        .checklist-item { margin: 8px 0; }
        .status { font-weight: bold; padding: 3px 8px; border-radius: 3px; }
        .status.pass { background: #d4edda; color: #155724; }
        .status.fail { background: #f8d7da; color: #721c24; }
        .status.pending { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ°Ô∏è Bulletproof Final Validation</h1>
        <p>Comprehensive validation of the bulletproof persistence fix for Docker + Vite + React environment.</p>

        <div class="checklist">
            <h3>‚úÖ Validation Checklist</h3>
            <div class="checklist-item">
                <span class="status pending" id="instant-status">PENDING</span> 
                <strong>Instant Appearance:</strong> Posts appear immediately after creation
            </div>
            <div class="checklist-item">
                <span class="status pending" id="reload-status">PENDING</span> 
                <strong>Hard Reload Persistence:</strong> Posts survive Ctrl+F5
            </div>
            <div class="checklist-item">
                <span class="status pending" id="restart-status">PENDING</span> 
                <strong>Browser Restart:</strong> Posts survive browser close/reopen
            </div>
            <div class="checklist-item">
                <span class="status pending" id="multitab-status">PENDING</span> 
                <strong>Multi-tab Sync:</strong> Posts sync across browser tabs
            </div>
            <div class="checklist-item">
                <span class="status pending" id="rapid-status">PENDING</span> 
                <strong>Rapid Creation:</strong> Multiple rapid posts all preserved
            </div>
        </div>

        <div>
            <h3>üöÄ Test Actions</h3>
            <button onclick="runFullValidation()">Run Full Validation Suite</button>
            <button onclick="testInstantAppearance()">Test Instant Appearance</button>
            <button onclick="testRapidCreation()">Test Rapid Creation</button>
            <button onclick="testHardReload()">Test Hard Reload</button>
            <button onclick="clearAllData()">Clear All Data</button>
        </div>

        <div id="results"></div>
        
        <div>
            <h3>üìä Validation Logs</h3>
            <div id="logs" class="logs">Ready for bulletproof validation...\n</div>
        </div>

        <div>
            <h3>üìà Live Status</h3>
            <div id="liveStatus"></div>
        </div>
    </div>

    <script>
        let testResults = [];
        let testPosts = [];

        function log(message) {
            const entry = `[${new Date().toISOString()}] ${message}`;
            console.log(entry);
            document.getElementById('logs').textContent += entry + '\n';
            document.getElementById('logs').scrollTop = document.getElementById('logs').scrollHeight;
        }

        function addResult(test, status, message, details = {}) {
            const result = { test, status, message, details, timestamp: new Date().toISOString() };
            testResults.push(result);

            const div = document.createElement('div');
            div.className = `test ${status}`;
            div.innerHTML = `
                <strong>${test}:</strong> ${status.toUpperCase()} - ${message}
                ${Object.keys(details).length > 0 ? `<br><small>Details: ${JSON.stringify(details)}</small>` : ''}
            `;
            document.getElementById('results').appendChild(div);
            
            log(`${test}: ${status.toUpperCase()} - ${message}`);
        }

        function updateChecklistStatus(checkId, status) {
            const element = document.getElementById(checkId);
            if (element) {
                element.className = `status ${status}`;
                element.textContent = status.toUpperCase();
            }
        }

        function checkBulletproofStore() {
            try {
                if (window.bulletproofPostStore) {
                    const posts = window.bulletproofPostStore.get();
                    return {
                        available: true,
                        count: posts.length,
                        hydrated: window.bulletproofPostStore.isHydrated(),
                        posts: posts.map(p => ({ id: p.id, title: p.title?.substring(0, 30) }))
                    };
                }
                return { available: false };
            } catch (error) {
                return { available: false, error: error.message };
            }
        }

        function checkLocalStorage() {
            try {
                const stored = localStorage.getItem('testingvala_posts');
                const posts = stored ? JSON.parse(stored) : [];
                return {
                    exists: !!stored,
                    count: posts.length,
                    posts: posts.map(p => ({ id: p.id, title: p.title?.substring(0, 30) }))
                };
            } catch (error) {
                return { error: error.message };
            }
        }

        function checkReactContext() {
            try {
                if (window.__GLOBAL_DATA_CONTEXT__) {
                    const posts = window.__GLOBAL_DATA_CONTEXT__.posts || [];
                    return {
                        available: true,
                        count: posts.length,
                        loading: window.__GLOBAL_DATA_CONTEXT__.loading,
                        hydrated: window.__GLOBAL_DATA_CONTEXT__.hydrated
                    };
                }
                return { available: false };
            } catch (error) {
                return { error: error.message };
            }
        }

        function updateLiveStatus() {
            const bulletproof = checkBulletproofStore();
            const localStorage = checkLocalStorage();
            const context = checkReactContext();

            const html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <tr style="background: #f8f9fa;">
                        <th style="border: 1px solid #ddd; padding: 8px;">Component</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Status</th>
                        <th style="border: 1px solid #ddd; padding: 8px;">Posts</th>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">Bulletproof Store</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">
                            <span class="status ${bulletproof.available ? 'pass' : 'fail'}">
                                ${bulletproof.available ? 'Available' : 'Not Available'}
                            </span>
                        </td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${bulletproof.count || 0}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">localStorage</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">
                            <span class="status ${localStorage.exists ? 'pass' : 'fail'}">
                                ${localStorage.exists ? 'Available' : 'Empty'}
                            </span>
                        </td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${localStorage.count || 0}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">React Context</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">
                            <span class="status ${context.available ? 'pass' : 'fail'}">
                                ${context.available ? 'Available' : 'Not Available'}
                            </span>
                        </td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${context.count || 0}</td>
                    </tr>
                </table>
            `;

            document.getElementById('liveStatus').innerHTML = html;
            return { bulletproof, localStorage, context };
        }

        function testInstantAppearance() {
            log('Testing instant appearance...');

            const beforeCount = checkBulletproofStore().count || 0;
            
            const testPost = {
                id: `instant_${Date.now()}`,
                title: `Instant Test ${new Date().toLocaleTimeString()}`,
                content: 'Testing instant appearance of posts',
                created_at: new Date().toISOString(),
                isLocal: true
            };

            testPosts.push(testPost.id);

            // Create post using bulletproof store
            if (window.bulletproofPostStore) {
                window.bulletproofPostStore.add(testPost);
                
                // Check immediately
                setTimeout(() => {
                    const afterCount = checkBulletproofStore().count || 0;
                    const appeared = afterCount > beforeCount;
                    
                    if (appeared) {
                        addResult('Instant Appearance', 'pass', 'Post appeared immediately');
                        updateChecklistStatus('instant-status', 'pass');
                    } else {
                        addResult('Instant Appearance', 'fail', 'Post did not appear immediately');
                        updateChecklistStatus('instant-status', 'fail');
                    }
                    
                    updateLiveStatus();
                }, 100);
            } else {
                addResult('Instant Appearance', 'fail', 'Bulletproof store not available');
                updateChecklistStatus('instant-status', 'fail');
            }
        }

        function testRapidCreation() {
            log('Testing rapid post creation...');

            const beforeCount = checkBulletproofStore().count || 0;
            const rapidPosts = [];

            // Create 5 posts rapidly
            for (let i = 0; i < 5; i++) {
                const post = {
                    id: `rapid_${Date.now()}_${i}`,
                    title: `Rapid Post #${i + 1}`,
                    content: `Rapid creation test post ${i + 1}`,
                    created_at: new Date().toISOString(),
                    isLocal: true
                };
                
                rapidPosts.push(post);
                testPosts.push(post.id);
                
                if (window.bulletproofPostStore) {
                    window.bulletproofPostStore.add(post);
                }
            }

            // Verify all posts were created
            setTimeout(() => {
                const afterCount = checkBulletproofStore().count || 0;
                const created = afterCount - beforeCount;
                
                if (created >= 5) {
                    addResult('Rapid Creation', 'pass', `All ${created} rapid posts preserved`);
                    updateChecklistStatus('rapid-status', 'pass');
                } else {
                    addResult('Rapid Creation', 'fail', `Only ${created}/5 rapid posts preserved`);
                    updateChecklistStatus('rapid-status', 'fail');
                }
                
                updateLiveStatus();
            }, 500);
        }

        function testHardReload() {
            log('Testing hard reload persistence...');
            
            const currentPosts = checkBulletproofStore().count || 0;
            
            if (currentPosts === 0) {
                addResult('Hard Reload Test', 'pending', 'No posts to test - create some first');
                return;
            }

            addResult('Hard Reload Test', 'pending', `Testing persistence of ${currentPosts} posts through hard reload`);
            
            const url = new URL(window.location);
            url.searchParams.set('bulletproof_reload', Date.now());
            url.searchParams.set('expected_posts', currentPosts);
            url.searchParams.set('test_posts', JSON.stringify(testPosts));
            
            setTimeout(() => {
                window.location.href = url.toString();
            }, 1000);
        }

        function clearAllData() {
            localStorage.removeItem('testingvala_posts');
            testPosts = [];
            testResults = [];
            document.getElementById('results').innerHTML = '';
            document.getElementById('logs').textContent = 'Data cleared - ready for new tests...\n';
            
            // Reset checklist
            ['instant-status', 'reload-status', 'restart-status', 'multitab-status', 'rapid-status'].forEach(id => {
                updateChecklistStatus(id, 'pending');
            });
            
            log('All test data cleared');
            updateLiveStatus();
        }

        function runFullValidation() {
            log('Starting full bulletproof validation suite...');
            
            // Clear previous results
            document.getElementById('results').innerHTML = '';
            testResults = [];
            
            // Test sequence
            testInstantAppearance();
            
            setTimeout(() => {
                testRapidCreation();
                
                setTimeout(() => {
                    const currentPosts = checkBulletproofStore().count || 0;
                    if (currentPosts > 0) {
                        addResult('Full Validation', 'pass', 'Ready for hard reload test - click "Test Hard Reload"');
                    } else {
                        addResult('Full Validation', 'fail', 'No posts created during validation');
                    }
                }, 1000);
            }, 500);
        }

        // Initialize and check for reload test
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const reloadTest = urlParams.get('bulletproof_reload');
            const expectedPosts = parseInt(urlParams.get('expected_posts')) || 0;
            const savedTestPosts = urlParams.get('test_posts');
            
            if (reloadTest) {
                log('Bulletproof reload test detected');
                
                if (savedTestPosts) {
                    try {
                        testPosts = JSON.parse(savedTestPosts);
                    } catch (error) {
                        log(`Error parsing test posts: ${error.message}`);
                    }
                }
                
                setTimeout(() => {
                    const currentPosts = checkBulletproofStore().count || 0;
                    
                    if (currentPosts >= expectedPosts && currentPosts > 0) {
                        addResult('Hard Reload Persistence', 'pass', `${currentPosts} posts survived hard reload`);
                        updateChecklistStatus('reload-status', 'pass');
                    } else {
                        addResult('Hard Reload Persistence', 'fail', `Expected ${expectedPosts}, found ${currentPosts} posts after reload`);
                        updateChecklistStatus('reload-status', 'fail');
                    }
                    
                    // Clean up URL
                    const cleanUrl = new URL(window.location);
                    cleanUrl.searchParams.delete('bulletproof_reload');
                    cleanUrl.searchParams.delete('expected_posts');
                    cleanUrl.searchParams.delete('test_posts');
                    window.history.replaceState({}, '', cleanUrl.toString());
                    
                    updateLiveStatus();
                }, 1000);
            }
            
            log('Bulletproof validation tool initialized');
            updateLiveStatus();
            
            // Auto-refresh status every 2 seconds
            setInterval(updateLiveStatus, 2000);
        });

        // Monitor storage events for multi-tab testing
        window.addEventListener('storage', (e) => {
            if (e.key === 'testingvala_posts') {
                log('Multi-tab storage event detected');
                updateChecklistStatus('multitab-status', 'pass');
                updateLiveStatus();
            }
        });
    </script>
</body>
</html>